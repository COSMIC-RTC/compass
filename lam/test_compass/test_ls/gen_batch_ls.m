 clear 
 
original_dir=pwd; 


gain=0.05:0.05:0.95;

diametre=[8 40 ];


lambda = 1.654;
pixsize = 0.3412; % pixsize a Shannon (= y_wfs(1:).lambda/(y_tel.diam/y_wfs(1:).nxsub)/2)

 
bruit = cell(length(diametre),1);
bruit_alpha_arcsec2 = cell(length(diametre),1);
bruit_gamma_px2 = cell(length(diametre),1);
bruit_alpha_rad2 = cell(length(diametre),1);
bruit_phi_rad2 = cell(length(diametre),1);


bruit{1} = [ 0.16 1.02 1.66 2.48 4.04 5.77 8.20 13.01 18.41 26.05 41.20 58.28 82.42]';% 130.3]';
 %bruit{2} = [ 0.241 0.535 0.986 1.45 2.1 3.36 4.76 6.75 10.68 15.11 21.38]';% 33.80]';
 %bruit{3} = [ 0.173 0.3213 0.4997 0.8302 1.1924 1.6991 2.6985 3.8219 5.4090]';% 8.5562]';
%bruit{4} = [0.048955 0.18051 0.30489 0.52353 0.75892 1.0861 1.72294 2.4515 3.4709]';% 5.4918]';
bruit{2} = [0.048955 0.18051 0.30489 0.52353 0.75892 1.0861 1.72294 2.4515 3.4709]';% 5.4918]';
      
 bruit_gamma_px2{1} = [ 1.000e-04 2.5000e-04 5.000e-04 ...
   1.000e-03 2.5000e-03 5.000e-03 ...
   1.000e-02 2.5000e-02 5.000e-02 ...
   1.000e-01 2.5000e-01 5.000e-01 ...
   1.000e-00]';% 2.5000e-00]';

% bruit_gamma_px2{2} = [5.000e-04 ...
%   1.000e-03 2.5000e-03 5.000e-03 ...
%  1.000e-02 2.5000e-02 5.000e-02 ...
%  1.000e-01 2.5000e-01 5.000e-01 ...
%  1.000e-00]';% 2.5000e-00]';

% bruit_gamma_px2{3} = [2.5000e-03 5.000e-03 ...
%   1.000e-02 2.5000e-02 5.000e-02 ...
%   1.000e-01 2.5000e-01 5.000e-01 ...
%   1.000e-00]';% 2.5000e-00]';     
 
%  bruit_gamma_px2{4} = [ 2.5000e-03 5.000e-03 ...
%     1.000e-02 2.5000e-02 5.000e-02 ...
%     1.000e-01 2.5000e-01 5.000e-01 ...
%     1.000e-00]';% 2.5000e-00]';
 bruit_gamma_px2{2} = [ 2.5000e-03 5.000e-03 ...
     1.000e-02 2.5000e-02 5.000e-02 ...
     1.000e-01 2.5000e-01 5.000e-01 ...
     1.000e-00]';% 2.5000e-00]';


for k=1:length(diametre)
    bruit_alpha_arcsec2{k} = bruit_gamma_px2{k} * pixsize^2;
    bruit_alpha_rad2{k} = bruit_alpha_arcsec2{k} * (pi/3600/180)^2;
    bruit_phi_rad2{k} = bruit_gamma_px2{k} * pi^2;
end


for dd=1:length(diametre)
    for ii=1:length(bruit{dd})
        for jj=1:length(gain)
            
            filename = sprintf('ls__%.2d_%08.4f_%010.3f.par',diametre(dd),bruit{dd}(ii),gain(jj));
            txt = sprintf([...
                'y_geom.zenithangle = 0.;\n',...
                'y_tel.diam = %f;\n',...
                'y_tel.cobs = 0.f;\n',...
                'y_atmos.r0           = 0.1249;\n',...
                'y_atmos.nscreens     = 3;\n',...
                'y_atmos.frac         = &([0.5,0.17,0.33]);\n',...
                'y_atmos.alt          = &([0.0,2500.,4000.]);\n',...
                'y_atmos.windspeed    = &([7.5,12.5,15]);\n',...
                'y_atmos.winddir      = &([0,90,0]);\n',...
                'y_atmos.L0           = &([25,25,25]);\n',...
                'y_target.ntargets = 1;\n',...
                'y_target.xpos     = &([0.0f]);\n',...
                'y_target.ypos     = &([0.0f]);\n',...
                'y_target.lambda   = &([1.654]);\n',...
                'y_target.mag      = &([10.]);\n',...
                'y_loop.niter  = 2000;\n',...
                'y_loop.ittime = 1/500.0f;\n',...
                'y_wfs                  = array(wfs_struct(),1);\n',...
                'y_wfs(1:).type          = "sh";\n',...
                'y_wfs(1:).nxsub         = %d;\n',...
                'y_wfs(1:).npix          = 14;\n',...
                'y_wfs(1:).pixsize       = 0.3412;\n',...
                'y_wfs(1:).fracsub       = 0.5;\n',...
                'y_wfs(1:).xpos          = 0.0;\n',...
                'y_wfs(1:).ypos          = 0.0;\n',...
                'y_wfs(1:).lambda        = 1.654;\n',...
                'y_wfs(1:).gsmag         = 5.;\n',...
                'y_wfs(1:).optthroughput = 0.5;\n',...
                'y_wfs(1:).zerop         = 1.e11;\n',...
                'y_wfs(1:).noise         = %e;\n',...
                'ndm = 2;\n',...
                'y_dm                  = array(dm_struct(),ndm);\n',...
                'y_dm(1).type          = "pzt";\n',...
                'y_dm(1).nact          = y_wfs(1).nxsub+1;\n',...
                'y_dm(1).alt           = 0.;\n',...
                'y_dm(1).thresh        = 0.3;\n',...
                'y_dm(1).coupling      = 0.2;\n',...
                'y_dm(1).unitpervolt   = 0.01;\n',...
                'y_dm(1).push4imat     = 100.0f;\n',...
                'y_dm(2).type          = "tt";\n',...
                'y_dm(2).alt           = 0.;\n',...
                'y_dm(2).unitpervolt   = 0.0005;\n',...
                'y_dm(2).push4imat     = 10.0f;\n',...
                'ncentroiders = 1;\n',...
                'y_centroiders           = array(centroider_struct(),ncentroiders);\n',...
                'y_centroiders.nwfs      = 1;\n',...
                'y_centroiders(1).type   = "cog";\n',...
                'ncontrollers = 1;\n',...
                'y_controllers          = array(controller_struct(),ncontrollers);\n',...
                'y_controllers(1).type    = "ls";\n',...
                'y_controllers(1).nwfs    = &[1];\n',...
                'y_controllers(1).ndm     = &[1,2];\n',...
                'y_controllers(1).maxcond = 150.;\n',...
                'y_controllers(1).delay   = 1;\n',...
                'y_controllers(1).gain    = %.3f;\n',...
                'y_rtc.nwfs =1;\n',...
                'y_rtc.centroiders = &(y_centroiders);\n',...
                'y_rtc.controllers  = &(y_controllers);\n'],diametre(dd),2*diametre(dd),bruit{dd}(ii),gain(jj));
            
            fid = fopen(['batch/' filename],'w');
            fprintf(fid,txt);
            fclose(fid);
            
        end
    end
end

cd(original_dir);
